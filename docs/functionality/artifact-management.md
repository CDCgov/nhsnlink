# Artifact Management

This document outlines the current state of artifact upload, storage, and usage in both the **measureeval** (evaluation) service and the **validation** service.

---

## Measure Evaluation (measureeval) Service

### Upload & Storage
- Bundles are uploaded via: `PUT /api/measureDefinition/:id`
- The uploaded bundle is a FHIR JSON Bundle and typically includes: `Measure`, `Library`, `StructureDefinition` (Profile), `ValueSet`, `CodeSystem`
- Bundles are stored **as-is** in the measureeval service's database.

> Note: Measure definition bundles that are generated by CQF Tooling do not include StructureDefinition resources that are necessary for validation. 

### Evaluation Execution
When a request is made to evaluate a measure:
1. The service checks if a `MeasureEvaluator` instance has already been compiled and cached.
2. If not, it:
   - Retrieves the corresponding bundle from the database.
   - Compiles a `MeasureEvaluator` instance.
   - Stores the compiled instance in memory/cache for future use.

**Terminology Handling:**
  - Currently, the bundle must include all required `ValueSet` and `CodeSystem` resources for evaluation to succeed.
  - There are future plans to integrate a FHIR Terminology (TX) Service, which would offload terminology expansion (e.g., `$expand`) and eliminate the need for local terminology resources in the bundle.
  - Note: At this time, value sets and code systems must be pre-expanded, or enumerate all of the codes that should be included in a value set's intensional definition. A terminology service is being explored to address this.

### Known Deficiencies
- **No version tracking**: Only a single bundle per `:id` is retained.
- **Overwrites are destructive**: Uploading a new bundle overwrites the existing one.
- **No version selection**: There is no support for evaluating a measure against a specific version of the bundle.

## Validation Service

### Upload & Storage

Artifacts are uploaded either individual or as an NPM package (preferred).

- Individually: `PUT /api/validation/artifact/:type/:name`
  - `type` = "RESOURCE"
  - `name` = FHIR resource `id`
- As a package: `PUT /api/validation/artifact/:type/:name`
  - `type` = "PACKAGE"
  - `name` = NPM package id

> Note: The Admin UI currently only supports uploading a FHIR `Bundle` of resources. Doing so implies that the Admin UI can only upload individual resources from that Bundle to the validation service. We may consider using NPM packages in the Admin UI and aligning the MeasureEval service and the Validation service to use just NPM packages.

### Validation Execution
- When validation is performed:
- The service loads **all artifacts** from the database into memory.
- It validates input data against all loaded profiles, value sets, and code systems. 

### Known Deficiencies
- **Global scope**: All stored artifacts are always loaded; there is no filtering or scoping based on tenant or package.
- **No tenant-specific configuration**: There is no ability to configure validation behavior per tenant or per package version.
- Use of the HAPI FHIR validation libraries only supports `CodeSystem`, `ValueSet`, and `StructureDefinition` resources.