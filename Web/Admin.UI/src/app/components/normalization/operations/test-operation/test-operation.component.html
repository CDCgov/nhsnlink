<mat-card class="operation-card">
  <form [formGroup]="form" class="operation-form">
    <!-- Run Test Button -->
    <div class="resource-row">
      <!-- Show static label if only one resource type -->
      @if (resourceTypes.length === 1) {
        <div class="resource-label">
          <label>Resource Type: </label>
          <span>{{ resourceTypes[0] }}</span>
        </div>
      } @else {
        <mat-form-field appearance="outline" floatLabel="always" class="resource-dropdown">
          <mat-label>Select resource type</mat-label>
          <mat-select formControlName="selectedResourceType">
            @for (resource of resourceTypes; track resource) {
              <mat-option [value]="resource">
                {{ resource }}
              </mat-option>
            }
          </mat-select>
          @if (selectedResourceTypeControl.hasError('required') && (selectedResourceTypeControl.touched || selectedResourceTypeControl.dirty)) {
            <mat-error
              >
              Resource type is required
            </mat-error>
          }
        </mat-form-field>
      }

      <!-- Show dropdown if more than one resource type -->
    </div>

    <!-- Horizontal Layout -->
    <div class="horizontal-container-3col">
      <!-- Original Resource -->
      <div class="section original">
        <div class="title-row">
          <h3>Original Resource (paste it below in JSON format)</h3>
          <button mat-stroked-button color="warn" (click)="clearResource()" [disabled]="!form.get('resourceJson')?.value">Clear</button>
        </div>

        <mat-form-field appearance="outline" class="textarea-field">
          <textarea
            matInput
            rows="38"
            formControlName="resourceJson"
          (input)="onJsonInputChange()" #jsonTextarea></textarea>
          @if (form.get('resourceJson')?.hasError('required') && (selectedResourceTypeControl.touched || selectedResourceTypeControl.dirty)) {
            <mat-error>
              Resource is required
            </mat-error>
          }
        </mat-form-field>
        @if (form.hasError('resourceTypeMismatch') && (form.get('resourceJson')?.dirty || form.get('selectedResourceType')?.dirty)) {
          <div
            class="error-message" style="color: red; margin-top: 8px;">
            Resource type in the resource does not match the resource type selected.
          </div>
        }
        @if (form.get('resourceJson')?.hasError('invalidJson')) {
          <div
            style="color: red; margin-top: 4px; font-size: 14px;">
            Invalid JSON format.
          </div>
        }
      </div>

      <div class="section operation">
        <div class="operation-header">
          <h3>Operation</h3>
          <button mat-raised-button color="primary" (click)="runTest()" [disabled]="form.invalid">Apply</button>
        </div>
        <div class="operations-details-container">
          @if (operation.operationType === OperationType.CopyProperty) {
            <div class="operations-details-row">
              <div class="data-label">Name</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.Name }}</div>
            </div>
            <div class="operations-details-row">
              <div class="data-label">Source FHIR Path</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.SourceFhirPath }}</div>
            </div>
            <div class="operations-details-row">
              <div class="data-label">Target FHIR Path</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.TargetFhirPath }}</div>
            </div>
          }

          @if (operation.operationType === OperationType.ConditionalTransform) {
            <div class="operations-details-row">
              <div class="data-label">Name</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.Name }}</div>
            </div>
            <div class="operations-details-row">
              <div class="data-label">Target FHIR Path</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.TargetFhirPath }}</div>
            </div>
            <div class="operations-details-row">
              <div class="data-label">Target Value</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.TargetValue }}</div>
            </div>
            <div class="sub-header">Conditions</div>
            <table class="code-table">
              <thead>
                <tr>
                  <th>Fhir Path Source</th>
                  <th>Operator</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
                @for (condition of operation.parsedOperationJson.Conditions; track condition) {
                  <tr>
                    <td>{{ condition.FhirPathSource }}</td>
                    <td>{{ condition.Operator }}</td>
                    <td>{{ condition.Value }}</td>
                  </tr>
                }
              </tbody>
            </table>
          }

          @if (operation.operationType === OperationType.CodeMap) {
            <div class="operations-details-row">
              <div class="data-label">Name</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.Name }}</div>
            </div>
            <div class="operations-details-row">
              <div class="data-label">Fhir Path</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.FhirPath }}</div>
            </div>
            <div class="sub-header">Code Maps</div>
            @for (systemMap of operation.parsedOperationJson.CodeSystemMaps; track systemMap) {
              <div class="code-system-map">
                <table class="code-table">
                  <thead>
                    <tr>
                      <th>Source System</th>
                      <th>Target System</th>
                      <th>Source Code</th>
                      <th>Target Code</th>
                      <th>Display</th>
                    </tr>
                  </thead>
                  <tbody>
                    @for (entry of systemMap.CodeMaps | keyvalue; track entry; let i = $index) {
                      <tr>
                        <!-- Show Source System and Target System only on first row -->
                        @if (i === 0) {
                          <td [attr.rowspan]="systemMap.CodeMaps.length">{{ systemMap.SourceSystem }}</td>
                        }
                        @if (i === 0) {
                          <td [attr.rowspan]="systemMap.CodeMaps.length">{{ systemMap.TargetSystem }}</td>
                        }
                        <!-- Empty cells for Source/Target system on other rows -->
                        @if (i !== 0) {
                          <td></td>
                        }
                        @if (i !== 0) {
                          <td></td>
                        }
                        <td>{{ entry.key }}</td>
                        <td>{{ entry.value.Code }}</td>
                        <td>{{ entry.value.Display }}</td>
                      </tr>
                    }
                  </tbody>
                </table>
              </div>
            }
          }

          @if (operation.operationType === OperationType.CopyLocation) {
            <div class="operations-details-row">
              <div class="data-label">Name</div>
              <div class="data-value selectable-value">{{ operation.parsedOperationJson.Name }}</div>
            </div>
          }

          @if (operation.operationType !== OperationType.CopyProperty && operation.operationType !== OperationType.ConditionalTransform && operation.operationType !== OperationType.CodeMap && operation.operationType !== OperationType.CopyLocation) {
            <p class="no-results-subtext">
              Unknown operation type: {{ operation.operationType }}. No additional details available.
            </p>
          }

        </div>
      </div>

      <!-- Transformed Resource -->
      <div class="section transformed">
        <h3>Transformed Resource</h3>
        <mat-form-field appearance="outline" class="textarea-field">
          <textarea
            matInput
            rows="38"
            [value]="testResult"
          [readonly]=""></textarea>
        </mat-form-field>
      </div>
    </div>
    <div style="text-align: right; margin-top: 16px;">
      <button mat-stroked-button color="warn" type="button" (click)="onClose()">
        Close
      </button>
    </div>
  </form>
</mat-card>

