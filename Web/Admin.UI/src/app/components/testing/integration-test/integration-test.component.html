<form [formGroup]="eventForm">

  <div class="content">
    <mat-toolbar class="page-header-bar" color="primary">
      <span>Link Integration Testing</span>
    </mat-toolbar>

    <mat-card class="resource-card">
      <mat-card-content>
        <div class="input-container">
          <mat-form-field class="form-select" appearance="outline">
            <span matPrefix><fa-icon [icon]="faSearch" class="fa-lg"></fa-icon></span>
            <mat-label>Facility</mat-label>
            <input
              matInput
              formControlName="facilityInput"
              [matAutocomplete]="auto"
              (blur)="onFacilityInputBlur()"
            >
            <button *ngIf="facilityInputControl.value" matSuffix mat-icon-button matTooltip="Clear" aria-label="Clear"
                    (click)="clearSearchInput()" class="clear-btn">
              <mat-icon>close</mat-icon>
            </button>
            <mat-autocomplete #auto="matAutocomplete"
                              (optionSelected)="onFacilitySelected($event.option.value)">
              <mat-option *ngFor="let fac of filteredFacilities | async" [value]="fac.facilityId">
                {{ fac.facilityId }}
              </mat-option>
            </mat-autocomplete>
          </mat-form-field>
          <!-- Facility error messages -->
          <div class="facility-errors-container">
            <div *ngIf="facilityIdControl.touched && facilityIdControl.hasError('required')"
                 class="facility-error">
              Facility is <strong>required</strong>
            </div>
            <div *ngIf="facilityIdControl.touched && facilityIdControl.hasError('notFound')"
                 class="facility-error">
              Facility <strong>not found</strong>
            </div>
          </div>
        </div>
        @if (isLoading) {
          <div class="spinner-container">
            <mat-progress-spinner
              color="primary"
              mode="indeterminate"
              diameter="50">
            </mat-progress-spinner>
          </div>
        } @else {
          <button mat-raised-button
                  color="primary"
                  (click)="onToggleTest()"
                  [disabled]="isLoading || eventForm.invalid">
            {{ isTestRunning ? 'Stop Test' : 'Start Test' }}
          </button>
        }
      </mat-card-content>
    </mat-card>

    @if (isTestRunning && consumersDataOutput.size > 0) {
      <mat-card class="resource-card">
        <mat-card-content>
          <div class="table-container">
            <table class="table" border="1" cellspacing="0" cellpadding="4">
              <thead>
              <tr>
                <th>Topic</th>
                <th>Correlation ID</th>
                <th *ngIf="hasAnyError(displayedEntries)">Trace ID</th>
                <th *ngIf="hasAnyError(displayedEntries)">Error Message</th>
              </tr>
              </thead>
              <tbody>
              <ng-container *ngFor="let entry of displayedEntries">
                <ng-container *ngIf="entry[1]?.length > 0; else noItems">
                  <tr *ngFor="let item of entry[1]; let i = index">
                    <!-- Topic column rowspan -->
                    <td *ngIf="i === 0" [attr.rowspan]="entry[1].length"
                        [style.color]="hasErrorInTopic(entry[0]) ? 'red' : 'black'">
                      {{ entry[0] }}
                    </td>

                    <!-- Correlation ID always -->
                    <td>{{ item.CorrelationId }}</td>

                    <!-- Trace ID only if error exists -->
                    <td *ngIf="item.ErrorMessage">{{ item.TraceId }}</td>

                    <!-- Error Message only if present -->
                    <td *ngIf="item.ErrorMessage" class="error-message">
                      <mat-expansion-panel class="error-panel"
                                           [expanded]="isPanelOpen(item.CorrelationId)"
                                           (opened)="togglePanel(item.CorrelationId, true)"
                                           (closed)="togglePanel(item.CorrelationId, false)">
                        <mat-expansion-panel-header>
                          <mat-panel-title class="error-text">
                            {{ item.ErrorMessage | slice:0:100 }}
                            <span *ngIf="item.ErrorMessage.length > 100">...</span>
                          </mat-panel-title>
                        </mat-expansion-panel-header>
                        <p class="error-text">{{ item.ErrorMessage }}</p>
                      </mat-expansion-panel>
                    </td>
                  </tr>
                </ng-container>

                <!-- Topic row when no items -->
                <ng-template #noItems>
                  <tr>
                    <td [style.color]="hasErrorInTopic(entry[0]) ? 'red' : 'black'">{{ entry[0] }}</td>
                    <td colspan="1"></td> <!-- Correlation ID blank -->
                    <td *ngIf="hasAnyError(displayedEntries)"></td>
                    <td *ngIf="hasAnyError(displayedEntries)"></td>
                  </tr>
                </ng-template>
              </ng-container>
              </tbody>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    }


    @if (isTestRunning && consumersDataOutput.size > 0) {
      <mat-card class="resource-card">
        <mat-card-content>
          <!-- Event Forms -->
          @if (showReportScheduledForm) {
            <app-report-scheduled-form [facilityId]="facilityId" [reportTrackingId]="reportTrackingId"
                                       (eventGenerated)="onEventGenerated($event)"
            ></app-report-scheduled-form>
          }
          @if (showPatientsAcquiredForm) {
            <app-patient-lists [facilityId]="facilityId" [reportTrackingId]="reportTrackingId"
                               (eventGenerated)="onEventGenerated($event)"
            ></app-patient-lists>
          }
        </mat-card-content>
      </mat-card>
    }

  </div>
</form>
